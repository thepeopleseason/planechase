<html>
<head>
<title>Eternities Map</title>
<style>
.myButton {
	-moz-box-shadow:inset 0px 1px 0px 0px #54a3f7;
	-webkit-box-shadow:inset 0px 1px 0px 0px #54a3f7;
	box-shadow:inset 0px 1px 0px 0px #54a3f7;
	background-color:#007dc1;
	-moz-border-radius:3px;
	-webkit-border-radius:3px;
	border-radius:3px;
	border:1px solid #124d77;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:arial;
	font-size:13px;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #154682;
    width: 150px;
}

.plane {
   text-align: center;
}

.current {
  border: 3px solid red;
}

.counter {
  font-size: 24px;
  font-weight: bold;
  text-align: right;
}

</style>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="planechase.js"></script>
<script type="text/javascript">

var neighbors = ['-1_0','0_1','0_-1','1_0'];

var init = 1;

function returnInt(element) {
  return parseInt(element, 10);
}

function get_point(index) {
  var point = index.split('_').map(returnInt);
  return point;
}

function get_distance(index) {
  var point = index.split('_');
  return Math.abs(point[0]) + Math.abs(point[1]);
}

function get_neighbors() {
  for (var x=0; x<neighbors.length; x++) {
    if (typeof eternity.map[neighbors[x]] == 'undefined') {
      eternity.map[neighbors[x]] = pick(eternity.planes);
    }
  }
}

function pheno_done() {
  $('#phenomenon').hide();
  $('#plane_div').show();
}

function move(index) {
  var point1 = get_point(index);
  var updatemap = {}

  // hide chaos symbol on planeswalk
  $('#chaos').hide();

  // when Hellriding, generate a new plane
  if (Math.abs(point1[0]) == 1 && Math.abs(point1[1]) == 1) {
    var all = eternity.planes.concat(eternity.phenomena);

    newplane = pick(all);
    // how to handle phenomena
    if (eternity.names[newplane].phenomenon) {
      var walkto = [];
      var phenomenon = newplane;

      // Interplanar Tunnel
      if (newplane == '226549.jpg') {
        var tmp_planes = eternity.planes.slice(0);

        // add 5 planes to choose from
        for (var x=0; x<5; x++) {
          walkto.push(pick(tmp_planes));
        }
      }
      // Spatial Merging (merge 2 planes)
      else if (newplane == '226546.jpg') {
        $('#phenomenon').html('<a href="#" onclick="pheno_done();">' +
                              '<img src="images/' + newplane +
                              '" height="450" title="'+ phenomenon +'"></a>');
        walkto.push(eternity.planes);
        walkto.push(eternity.planes);

        updatemap['0_0'] = newplane;
      }
      else {
        $('#plane_div').hide();
        newplane = pick(eternity.planes);
      }

      var output = '';
      for (pl in walkto) {
        height = (walkto.length > 1) ? 45: 80;
        var img = '<img src="images/' + walkto[pl] +
          '" height="' + height + '%">';
        if (walkto.indexOf('226549.jpg') >= 0) {
          output += '<a href="#" onclick="load(\'' +
            walkto[pl] + '\')">' + img + '</a>';
        }
        else {
          output += '<a href="#" onclick="roll();">' + img + '</a>';
        }
      }
      $('#phenomenon').html(output);
      $('#phenomenon').show();
    }
    else {
      eternity.planes.splice(eternity.planes.indexOf(newplane), 1);
    }
    updatemap['0_0'] = newplane;
  }

  // Reposition all existing planes in the map
  $.each(eternity.map, function(key, value) {
    if (typeof value != 'undefined') {
      var point2 = get_point(key);
      point2[0] -= point1[0];
      point2[1] -= point1[1];
      newindex = point2.join('_');

      // remove all planes greater than 3 hops away
      if (get_distance(newindex) < 4) {
        updatemap[newindex] = value;
      }
      else {
        // return removed planes back to the planar deck
        eternity.planes.push(value);
        if (Object.keys(eternity.counter_planes).indexOf(value) >= 0) {
          eternity.counter_planes[value] = 0;
        }
      }
    }
  });

  // update the map, draw new neighbors
  eternity.map = updatemap;
  get_neighbors();
  draw_map();
}

function draw_map() {
  for (var x=0; x<eternity.cells.length; x++) {
    $("#cell_"+eternity.cells[x]).html('');
    if (typeof eternity.map[eternity.cells[x]] != 'undefined') {
      link = get_link(eternity.map[eternity.cells[x]], eternity.cells[x]);
      if ((Object.keys(eternity.counter_planes).indexOf(eternity.map[eternity.cells[x]]) >= 0) &&
        eternity.cells[x] == '0_0' &&
          Object.keys(eternity.map).indexOf(eternity.cells[x]) >= 0) {
        link += '<p class="counter"> Counters:' +
          eternity.counter_planes[eternity.map[eternity.cells[x]]] + '</p>';
      }
      $("#cell_"+eternity.cells[x]).html(link);
    }
  }

  // allow for hellriding
  var hellrides = ['1_1', '-1_1', '-1_-1', '1_-1'];
  if (!init) {
    $('#toolbar').show();
    for (var x in hellrides) {
      if (typeof eternity.map[hellrides[x]] == 'undefined') {
        $("#cell_"+hellrides[x]).html('<input type="button" value="Hellride" onclick="move(\''+hellrides[x]+'\');" class="myButton">');
      }
    }
  }
}

function get_link(plane, index) {
  var dist = get_distance(index);
  var img = '<img src="images/' + plane + '" width="' +
    (dist >= 2 ? 450 / (1 + 0.7 * dist) : 450) +
    '" title="'+ eternity.names[plane].name + ':' +
    index +'">';
  var link = ''
  if (dist == 1) {
    link = '<a href="#" onclick="move(\'' + index + '\');">';
  }
  else if (index == '0_0') {
    if (!init && Object.keys(eternity.counter_planes).indexOf(plane) >= 0) {
      link = '<a href="#" onclick="add_counter(\''+plane+'\');">';
    }
    else {
      link = '<a href="#" onclick="draw_map();">';
    }
  }
  if (link) {
    return link.concat(img, '</a>');
  }
  else {
    return img;
  }
}

function add_counter(plane) {
  eternity.counter_planes[plane]++;
  draw_map();
}

function roll() {
  var result = 0;
  var diceroll = Math.round(Math.random()*5);

  // clear current chaos
  $("#chaos").hide();

  // 0-3: blank roll
  // 4: chaos
  // 5: planeswalk
  result = (diceroll == 5) ? diceroll :
    (chaotic_aether) ? 4 : diceroll;

  if (result > 3) {
    if (result == 4) {
      // display chaos symbol
      $("#chaos").show();
    }
  }
}

$(document).ready(function () {
  // $(document).bind('keyup', 'n', function() { move('0_1'); });
  // $(document).bind('keyup', 's', function() { move('0_-1'); });
  // $(document).bind('keyup', 'e', function() { move('1_0'); });
  // $(document).bind('keyup', 'w', function() { move('-1_0'); });

  eternity.map['0_0'] = pick(eternity.planes);
  // eternity.map['0_0'] = '226523.jpg';
  draw_map();
  get_neighbors();
  init = 0;
});

</script>
</head>
<body style="text-align: center;">
<div id="chaos" style="position: absolute; display: none;"><img src="images/chaos.png"></div>
</div>
<div id="toolbar" style="float: top; display: none;">
<input type="button" value="Roll Planar Die" onclick="roll();" class="myButton">
</div>
<div id="phenomenon" style="display: none;"></div>
<div id="plane_div" style="margin: 10 auto;">
<table width="100%" height="100%">
<tr><td colspan="3"></td>
  <td class="plane" id="cell_0_3">0_3</td>
  <td colspan="3"></td></tr>
<tr><td colspan="2"></td>
  <td class="plane" id="cell_-1_2">-1_2</td>
  <td class="plane" id="cell_0_2">0_2</td>
  <td class="plane" id="cell_1_2">1_2</td>
  <td colspan="2"></td></tr>
<tr><td colspan="1"></td>
  <td class="plane" id="cell_-2_1">-2_1</td>
  <td class="plane" id="cell_-1_1">-1_1</td>
  <td class="plane" id="cell_0_1">0_1</td>
  <td class="plane" id="cell_1_1">1_1</td>
  <td class="plane" id="cell_2_1">2_1</td>
  <td colspan="1"></td></tr>
<tr><td class="plane" id="cell_-3_0">-3_0</td>
  <td class="plane" id="cell_-2_0">-2_0</td>
  <td class="plane" id="cell_-1_0">-1_0</td>
  <td class="plane current" id="cell_0_0">0_0</td>
  <td class="plane" id="cell_1_0">1_0</td>
  <td class="plane" id="cell_2_0">2_0</td>
  <td class="plane" id="cell_3_0">3_0</td></tr>
<tr><td colspan="1"></td>
  <td class="plane" id="cell_-2_-1">-2_-1</td>
  <td class="plane" id="cell_-1_-1">-1_-1</td>
  <td class="plane" id="cell_0_-1">0_-1</td>
  <td class="plane" id="cell_1_-1">1_-1</td>
  <td class="plane" id="cell_2_-1">2_-1</td>
  <td colspan="1"></td></tr>
<tr><td colspan="2"></td>
  <td class="plane" id="cell_-1_-2">-1_-2</td>
  <td class="plane" id="cell_0_-2">0_-2</td>
  <td class="plane" id="cell_1_-2">1_-2</td>
  <td colspan="2"></td></tr>
<tr><td colspan="3"></td>
  <td class="plane" id="cell_0_-3">0_-3</td>
  <td colspan="3"></td></tr>
</table>
</div>
</body>
</html>
