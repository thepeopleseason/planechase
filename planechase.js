var eternity = {
  "names": {
    "opca-1-chaotic-aether.png": { "name": "Chaotic Aether", "phenomenon": true, },
    "opca-2-interplanar-tunnel.png": { "name": "Interplanar Tunnel", "phenomenon": true,
                                       "link": "load", },
    "opca-3-morphic-tide.png": { "name": "Morphic Tide", "phenomenon": true, },
    "opca-4-mutual-epiphany.png": { "name": "Mutual Epiphany", "phenomenon": true, },
    "opca-5-planewide-disaster.png": { "name": "Planewide Disaster", "phenomenon": true, },
    "opca-6-reality-shaping.png": { "name": "Reality Shaping", "phenomenon": true, },
    "opca-7-spatial-merging.png": { "name": "Spatial Merging", "phenomenon": true,
                                    "link": "merged", },
    "opca-8-time-distortion.png": { "name": "Time Distortion", "phenomenon": true, },
    "opca-9-academy-at-tolaria-west.png": { "name": "Academy At Tolaria West", },
    "opca-10-the-aether-flues.png": { "name": "The Aether Flues", },
    "opca-11-agyrem.png": { "name": "Agyrem", },
    "opca-12-akoum.png": { "name": "Akoum", },
    "opca-13-aretopolis.png": { "name": "Aretopolis", "counter": 1, },
    "opca-14-astral-arena.png": { "name": "Astral Arena", },
    "opca-15-bant.png": { "name": "Bant", },
    "opca-16-bloodhill-bastion.png": { "name": "Bloodhill Bastion", },
    "opca-17-celestine-reef.png": { "name": "Celestine Reef", },
    "opca-18-cliffside-market.png": { "name": "Cliffside Market", },
    "opca-19-the-dark-barony.png": { "name": "The Dark Barony", },
    "opca-20-edge-of-malacol.png": { "name": "Edge of Malacol", },
    "opca-21-eloren-wilds.png": { "name": "Eloren Wilds", },
    "opca-22-the-eon-fog.png": { "name": "The Eon Fog", },
    "opca-23-feeding-grounds.png": { "name": "Feeding Grounds", },
    "opca-24-fields-of-summer.png": { "name": "Fields of Summer", },
    "opca-25-the-fourth-sphere.png": { "name": "The Fourth Sphere", },
    "opca-26-furnace-layer.png": { "name": "Furnace Layer", },
    "opca-27-gavony.png": { "name": "Gavony", },
    "opca-28-glen-elendra.png": { "name": "Glen Elendra", },
    "opca-29-glimmervoid-basin.png": { "name": "Glimmervoid Basin", },
    "opca-30-goldmeadow.png": { "name": "Goldmeadow", },
    "opca-31-grand-ossuary.png": { "name": "Grand Ossuary", },
    "opca-32-the-great-forest.png": { "name": "The Great Forest", },
    "opca-33-grixis.png": { "name": "Grixis", },
    "opca-34-grove-of-the-dreampods.png": { "name": "Grove of The Dreampods", },
    "opca-35-hedron-fields-of-agadeem.png": { "name": "Hedron Fields of Agadeem", },
    "opca-36-the-hippodrome.png": { "name": "The Hippodrome", },
    "opca-37-horizon-boughs.png": { "name": "Horizon Boughs", },
    "opca-38-immersturm.png": { "name": "Immersturm", },
    "opca-39-isle-of-vesuva.png": { "name": "Isle of Vesuva", },
    "opca-40-izzet-steam-maze.png": { "name": "Izzet Steam Maze", },
    "opca-41-jund.png": { "name": "Jund", },
    "opca-42-kessig.png": { "name": "Kessig", },
    "opca-43-kharasha-foothills.png": { "name": "Kharasha Foothills", },
    "opca-44-kilnspire-district.png": { "name": "Kilnspire District", "counter": 1, },
    "opca-45-krosa.png": { "name": "Krosa", },
    "opca-46-lair-of-the-ashen-idol.png": { "name": "Lair of The Ashen Idol", },
    "opca-47-lethe-lake.png": { "name": "Lethe Lake", },
    "opca-48-llanowar.png": { "name": "Llanowar", },
    "opca-49-the-maelstrom.png": { "name": "The Maelstrom", },
    "opca-50-minamo.png": { "name": "Minamo", },
    "opca-51-mirrored-depths.png": { "name": "Mirrored Depths", },
    "opca-52-mount-keralia.png": { "name": "Mount Keralia", "counter": 0, },
    "opca-53-murasa.png": { "name": "Murasa", },
    "opca-54-naar-isle.png": { "name": "Naar Isle", "counter": 0, },
    "opca-55-naya.png": { "name": "Naya", },
    "opca-56-nephalia.png": { "name": "Nephalia", },
    "opca-57-norn-s-dominion.png": { "name": "Norn's Dominion", },
    "opca-58-onakke-catacomb.png": { "name": "Onakke Catacomb", },
    "opca-59-orochi-colony.png": { "name": "Orochi Colony", },
    "opca-60-orzhova.png": { "name": "Orzhova", },
    "opca-61-otaria.png": { "name": "Otaria", },
    "opca-62-panopticon.png": { "name": "Panopticon", },
    "opca-63-pools-of-becoming.png": { "name": "Pools of Becoming", },
    "opca-64-prahv.png": { "name": "Prahv", },
    "opca-65-quicksilver-sea.png": { "name": "Quicksilver Sea", },
    "opca-66-raven-s-run.png": { "name": "Raven's Run", },
    "opca-67-sanctum-of-serra.png": { "name": "Sanctum of Serra", },
    "opca-68-sea-of-sand.png": { "name": "Sea of Sand", },
    "opca-69-selesnya-loft-gardens.png": { "name": "Selesnya Loft Gardens", },
    "opca-70-shiv.png": { "name": "Shiv", },
    "opca-71-skybreen.png": { "name": "Skybreen", },
    "opca-72-sokenzan.png": { "name": "Sokenzan", },
    "opca-73-stairs-to-infinity.png": { "name": "Stairs To Infinity", },
    "opca-74-stensia.png": { "name": "Stensia", },
    "opca-75-stronghold-furnace.png": { "name": "Stronghold Furnace", },
    "opca-76-takenuma.png": { "name": "Takenuma", },
    "opca-77-talon-gates.png": { "name": "Talon Gates", },
    "opca-78-tazeem.png": { "name": "Tazeem", },
    "opca-79-tember-city.png": { "name": "Tember City", },
    "opca-80-trail-of-the-mage-rings.png": { "name": "Trail of The Mage Rings", },
    "opca-81-truga-jungle.png": { "name": "Truga Jungle", },
    "opca-82-turri-island.png": { "name": "Turri Island", },
    "opca-83-undercity-reaches.png": { "name": "Undercity Reaches", },
    "opca-84-velis-vel.png": { "name": "Velis Vel", },
    "opca-85-windriddle-palaces.png": { "name": "Windriddle Palaces", },
    "opca-86-the-zephyr-maze.png": { "name": "The Zephyr Maze", },
  },
  "planes": [
    "opca-9-academy-at-tolaria-west.png",
    "opca-10-the-aether-flues.png", "opca-11-agyrem.png",
    "opca-12-akoum.png", "opca-13-aretopolis.png",
    "opca-14-astral-arena.png", "opca-15-bant.png",
    "opca-16-bloodhill-bastion.png", "opca-17-celestine-reef.png",
    "opca-18-cliffside-market.png", "opca-19-the-dark-barony.png",
    "opca-20-edge-of-malacol.png", "opca-21-eloren-wilds.png",
    "opca-22-the-eon-fog.png", "opca-23-feeding-grounds.png",
    "opca-24-fields-of-summer.png", "opca-25-the-fourth-sphere.png",
    "opca-26-furnace-layer.png", "opca-27-gavony.png",
    "opca-28-glen-elendra.png", "opca-29-glimmervoid-basin.png",
    "opca-30-goldmeadow.png", "opca-31-grand-ossuary.png",
    "opca-32-the-great-forest.png", "opca-33-grixis.png",
    "opca-34-grove-of-the-dreampods.png",
    "opca-35-hedron-fields-of-agadeem.png",
    "opca-36-the-hippodrome.png", "opca-37-horizon-boughs.png",
    "opca-38-immersturm.png", "opca-39-isle-of-vesuva.png",
    "opca-40-izzet-steam-maze.png", "opca-41-jund.png",
    "opca-42-kessig.png", "opca-43-kharasha-foothills.png",
    "opca-44-kilnspire-district.png", "opca-45-krosa.png",
    "opca-46-lair-of-the-ashen-idol.png", "opca-47-lethe-lake.png",
    "opca-48-llanowar.png", "opca-49-the-maelstrom.png",
    "opca-50-minamo.png", "opca-51-mirrored-depths.png",
    "opca-52-mount-keralia.png", "opca-53-murasa.png",
    "opca-54-naar-isle.png", "opca-55-naya.png",
    "opca-56-nephalia.png", "opca-57-norn-s-dominion.png",
    "opca-58-onakke-catacomb.png", "opca-59-orochi-colony.png",
    "opca-60-orzhova.png", "opca-61-otaria.png",
    "opca-62-panopticon.png", "opca-63-pools-of-becoming.png",
    "opca-64-prahv.png", "opca-65-quicksilver-sea.png",
    "opca-66-raven-s-run.png", "opca-67-sanctum-of-serra.png",
    "opca-68-sea-of-sand.png", "opca-69-selesnya-loft-gardens.png",
    "opca-70-shiv.png", "opca-71-skybreen.png",
    "opca-72-sokenzan.png", "opca-73-stairs-to-infinity.png",
    "opca-74-stensia.png", "opca-75-stronghold-furnace.png",
    "opca-76-takenuma.png", "opca-77-talon-gates.png",
    "opca-78-tazeem.png", "opca-79-tember-city.png",
    "opca-80-trail-of-the-mage-rings.png", "opca-81-truga-jungle.png",
    "opca-82-turri-island.png", "opca-83-undercity-reaches.png",
    "opca-84-velis-vel.png", "opca-85-windriddle-palaces.png",
    "opca-86-the-zephyr-maze.png",
  ],
  "phenomena": [
    "opca-1-chaotic-aether.png", "opca-2-interplanar-tunnel.png",
    "opca-3-morphic-tide.png", "opca-4-mutual-epiphany.png",
    "opca-5-planewide-disaster.png", "opca-6-reality-shaping.png",
    "opca-7-spatial-merging.png", "opca-8-time-distortion.png",
  ],
  "cells": [
    "0_3", "-1_2", "0_2", "1_2", "-2_1", "-1_1", "0_1", "1_1", "2_1",
    "-3_0", "-2_0", "-1_0", "0_0", "1_0", "2_0", "3_0", "-2_-1", "-1_-1",
    "0_-1", "1_-1", "2_-1", "-1_-2", "0_-2", "1_-2", "0_-3"
  ],
  "hellrides": ["1_1", "-1_1", "-1_-1", "1_-1"],
  "map": {},
  "history": [],
  "chaotic_aether": 0
};

function pick(my_array) {
  index = Math.floor(Math.random() * my_array.length);
  return my_array.splice(index, 1)[0];
}

function roll() {
  // Planeswalk on button re-press. Skip if you're mapping
  if ($('#dice_button')[0].value == 'Planeswalk'
      && !Object.keys(eternity.map).length) {
    walk();
  }
  else {
    var result = 0;
    var diceroll = Math.round(Math.random()*5);

    // 0-3: blank roll
    // 4: chaos
    // 5: planeswalk
    result = (diceroll == 5) ? diceroll :
      (eternity.chaotic_aether) ? 4 : diceroll;

    var dice_result;
    switch (result) {
    case 4:
      dice_result = "Chaos";
      break;
    case 5:
      dice_result = "Planeswalk";
      break;
    default:
      dice_result = "Roll Planar Die";
      break;
    }
    $('#dice_button')[0].value = dice_result;
    if (dice_result === 'Planeswalk') {
      reset_cost();
    }
    else {
      $('#cost_button')[0].value = parseInt($('#cost_button')[0].value) + 1;
    }
  }
}

function walk(plane) {
  var walkto = [];

  reset_plane();
  if (plane) {
    walkto.push(plane);
  }
  else {
    var all = Object.keys(eternity.names);
    walkto.push(pick(all));

    // encountered a phenomenon
    while (eternity.names[walkto[walkto.length-1]].phenomenon) {
      // Interplanar Tunnel (choose from 5 planes)
      if (walkto[walkto.length-1] == '226549.jpg') {
        var tmp_planes = eternity.planes.slice(0);

        // add 5 planes to choose from
        for (var x=0; x<5; x++) {
          walkto.push(pick(tmp_planes));
        }
      }
      // Spatial Merging (merge 2 planes)
      else if (walkto[walkto.length-1] == '226546.jpg') {
        walkto.push(pick(eternity.planes));
        walkto.push(pick(eternity.planes));
      }
      else {
        // Chaotic Aether
        if (walkto[walkto.length-1] == '226509.jpg') {
          eternity.chaotic_aether = 1;
        }

        // Subsequent plane
        walkto.push(pick(all));
      }
    }
  }
  var output = '';
  for (pl in walkto) {
    var img = `<img src="images/${ walkto[pl] }" height="${ (walkto.length > 1) ? 50 : 80 }%">`
    if (walkto.indexOf('226549.jpg') >= 0) {
      output += `<a href="#" onclick="load('${ walkto[pl] }')">${ img }</a>`;
    }
    else {
      output += `<a href="#"${ get_link(walkto[pl]) }>${ img }</a>`;
    }
    if (typeof eternity.names[walkto[pl]].counter != 'undefined') {
      eternity.current_planar_count = eternity.names[walkto[pl]].counter;
    }
    else {
      eternity.current_planar_count = '---';
    }
    update_count('count_button', eternity.current_planar_count);
  }
  $("#plane").html(output);
  eternity.history.push(eternity.names[walkto[pl]].name);
}

function get_link(plane) {
  var link = '';
  if (!eternity.names[plane].phenomenon) {
    if (typeof eternity.names[plane].counter != 'undefined') {
      link = ` onclick="add_counter('${ plane }');"`;
    }
    else {
      link = ' onclick="walk();"';
    }
  }
  return link;
}

function add_counter(plane) {
  update_count('count_button', ++eternity.current_planar_count);
}

function reset_cost() {
  $('#cost_button')[0].value = 0;
}

function reset_plane() {
  $('#dice_button')[0].value = 'Roll Planar Die';
  $('#cost_button')[0].value = 0;
  eternity.current_planar_count = 0;
  if (eternity.chaotic_aether) {
    eternity.chaotic_aether = 0;
  }
}

function update_count(id, count) {
  $("#" + id)[0].value = count;
}

function help() {
  $("#help").html(get_help());
  $("#help").dialog();
}
